<UserControl 
    x:Class="MVVM_Base.View.viewBalw"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:Icon="http://metro.mahapps.com/winfx/xaml/iconpacks"
    xmlns:converter="clr-namespace:MVVM_Base.Common"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    Style="{StaticResource Page_Style}" Cursor=""
    xmlns:local="clr-namespace:MVVM_Base.Common"
    Loaded="UserControl_Loaded">

    <i:Interaction.Triggers>
        <i:EventTrigger EventName="PreviewKeyDown">
            <i:InvokeCommandAction Command="{Binding AdjustUICommand}" PassEventArgsToCommand="True" />
        </i:EventTrigger>
        <i:EventTrigger EventName="PreviewMouseWheel">
            <i:InvokeCommandAction Command="{Binding AdjustUICommand}" PassEventArgsToCommand="True" />
        </i:EventTrigger>
    </i:Interaction.Triggers>

    <UserControl.Resources>
        <converter:EnumToBooleanConverter x:Key="EnumToBooleanConverter" />
        <converter:InverseBoolConverter x:Key="InverseBoolConverter" />

        <Style x:Key="MeasureTextCenterStyle" TargetType="TextBlock">
            <Setter Property="FontSize" 
                    Value="{Binding DataContext.LogFontSize, RelativeSource={RelativeSource AncestorType=ItemsControl}}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style 
            x:Key="MeasureTextLeftStyle"
            TargetType="TextBlock"
            BasedOn="{StaticResource MeasureTextCenterStyle}">
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="Margin" Value="4,0,0,0"/>
        </Style>

        <Style x:Key="MeasureTextBoxCenterStyle" TargetType="TextBox">
            <Setter Property="FontSize" Value="{Binding DataContext.LogFontSize,
                                                    RelativeSource={RelativeSource AncestorType=ItemsControl}}"/>
            <Setter Property="TextAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,0,0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Grid>
                            <!-- 背景（通常 = Transparent）-->
                            <Border 
                                x:Name="BgBorder"
                                Background="Transparent"
                                Padding="{TemplateBinding Padding}">
                                <ScrollViewer x:Name="PART_ContentHost"/>
                            </Border>
                        </Grid>

                        <!-- フォーカス時の色変更 -->
                        <ControlTemplate.Triggers>
                            <!-- TextBoxがフォーカス中 -->
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <!-- 背景色変更 -->
                                <Setter 
                                TargetName="BgBorder"
                                Property="Background"
                                Value="{DynamicResource ButtonThemeColorBrush2}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MeasureCellBorderStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="{DynamicResource ButtonThemeColorBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Background" Value="Transparent" />

            <Style.Triggers>
                <!-- 1行目（AlternationIndex == 0） -->
                <DataTrigger 
                    Binding="{Binding RelativeSource={RelativeSource AncestorType=ContentPresenter},
                    Path=(ItemsControl.AlternationIndex)}"
                    Value="0">
                    <Setter Property="BorderBrush" Value="{DynamicResource ButtonThemeColorBrush2}" />
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="LogGroupBoxStyle" TargetType="GroupBox">
            <Setter Property="Foreground" Value="{DynamicResource AccentBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupBox">
                        <Border
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="5"
                            Background="Transparent"
                            SnapsToDevicePixels="True">

                            <Grid>
                                <Grid.RowDefinitions>
                                    <!-- Header -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Content -->
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Header -->
                                <ContentPresenter
                                    Grid.Row="0"
                                    ContentSource="Header"
                                    RecognizesAccessKey="True"
                                    Margin="5"
                                    ContentTemplate="{TemplateBinding HeaderTemplate}"/>

                                <!-- Content -->
                                <ContentPresenter
                                    Grid.Row="1"
                                    Margin="{TemplateBinding Padding}"/>
                            </Grid>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ▼ GroupBoxマージン小 共通スタイル -->
        <Style x:Key="BalwGroupBoxStyle" TargetType="GroupBox">
            <Setter Property="Foreground" Value="{DynamicResource AccentBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="3"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupBox">
                        <Border 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="2" 
                                CornerRadius="5" 
                                Background="Transparent" 
                                SnapsToDevicePixels="True">

                            <DockPanel>
                                <!-- ★ 下線つきヘッダーをテンプレートで差し替える -->
                                <ContentPresenter 
                                        x:Name="HeaderContent"
                                        ContentSource="Header" 
                                        RecognizesAccessKey="True"
                                        Margin="5"
                                        DockPanel.Dock="Top"
                                        ContentTemplate="{TemplateBinding HeaderTemplate}"/>

                                <ContentPresenter Margin="{TemplateBinding Padding}"/>
                            </DockPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </UserControl.Resources>

    <!-- 全体Grid -->
    <Grid Margin="10 0 0 0">
        <ScrollViewer
            x:Name="MyScrollViewer"
            HorizontalScrollBarVisibility="Auto"
            VerticalScrollBarVisibility="Auto"
            ScrollChanged="ScrollViewer_ScrollChanged"
            PreviewMouseUp="ScrollViewer_PreviewMouseUp"
            PreviewMouseDown="ScrollViewer_PreviewMouseDown"
            PreviewMouseMove="ScrollViewer_PreviewMouseMove"
            PreviewMouseWheel="ScrollViewer_PreviewMouseWheel" Cursor="">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Grid Margin="0" Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- 最上段Grid s/h,流量,計測設定, FB -->
                    <Grid Grid.Row="0" HorizontalAlignment="Left" Margin="0 10 0 0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- 1段目Grid s/h,流量,計測設定 -->
                        <Grid Grid.Row="0" HorizontalAlignment="Left">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- 通信状態 -->
                            <GroupBox Grid.Row="0" Grid.Column="0" Margin="3 0 0 0"
                                Style="{StaticResource BalwGroupBoxStyle}"    
                                BorderThickness="2"
                                      VerticalAlignment="Center"
                                Height="{Binding CommBoxHeight}"
                                Width="{Binding CommBoxWidth}">
                                <GroupBox.Header>
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <TextBlock 
                                        Text="Comm" 
                                        Foreground="{DynamicResource AccentBrush}" 
                                        FontSize="{Binding TitleFontSize}" 
                                        FontWeight="Bold"/>
                                    </StackPanel>
                                </GroupBox.Header>

                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel
                                        Grid.Column="0"
                                        Orientation="Horizontal" 
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Margin="0 10 0 0">
                                        <Icon:PackIconMaterial 
                                        Kind="CameraRear"
                                        Width="{Binding IconSize}" 
                                        Height="{Binding IconSize}"
                                        VerticalAlignment="Center"
                                        Foreground="{DynamicResource AccentBrush}"/>

                                        <Icon:PackIconMaterial
                                            Kind="AccessPointNetwork"
                                            Width="{Binding IconSize}" 
                                            Height="{Binding IconSize}"
                                            Margin="10,0,0,0"
                                            VerticalAlignment="Center"
                                            Visibility="{Binding IsMfcPortSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <Icon:PackIconMaterial.Foreground>
                                                <LinearGradientBrush 
                                                StartPoint="0,0" 
                                                EndPoint="1,0">
                                                    <GradientStop 
                                                    x:Name="MfcCommIconColor" 
                                                    Color="{DynamicResource CommIconColorFrom}"
                                                    Offset="0"/>
                                                </LinearGradientBrush>
                                            </Icon:PackIconMaterial.Foreground>
                                        </Icon:PackIconMaterial>
                                    </StackPanel>

                                    <StackPanel 
                                        Grid.Row="1" 
                                        Orientation="Horizontal" 
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Margin="0 20 0 0">
                                        <Icon:PackIconMaterial 
                                            Kind="ScaleBalance"
                                            Width="{Binding IconSize}" 
                                            Height="{Binding IconSize}"
                                            VerticalAlignment="Center"
                                            Foreground="{DynamicResource AccentBrush}"/>

                                        <Icon:PackIconMaterial 
                                            Kind="AccessPointNetwork"
                                            Width="{Binding IconSize}" 
                                            Height="{Binding IconSize}"
                                            Margin="10,0,0,0"
                                            VerticalAlignment="Center"
                                            Visibility="{Binding IsBalancePortSelected, Converter={StaticResource BoolToVisibilityConverter}}" Cursor="">
                                            <Icon:PackIconMaterial.Foreground>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                    <GradientStop x:Name="BalanceCommIconColor" Color="{DynamicResource CommIconColorFrom}" Offset="0"/>
                                                </LinearGradientBrush>
                                            </Icon:PackIconMaterial.Foreground>
                                        </Icon:PackIconMaterial>
                                    </StackPanel>
                                </Grid>
                            </GroupBox>

                            <!-- ▼ Timer Setting グループ -->
                            <GroupBox Grid.Row="0" Grid.Column="1" Margin="5 0 0 0"
                                 Style="{StaticResource BalwGroupBoxStyle}"
                                      Height="{Binding CommBoxHeight}"
                                 Width="{Binding TimerSettingBoxWidth}">
                                <GroupBox.Header>
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <TextBlock 
                                        Text="Timer Settings" 
                                        Foreground="{DynamicResource AccentBrush}" 
                                        FontSize="{Binding TitleFontSize}" 
                                        FontWeight="Bold"/>
                                    </StackPanel>
                                </GroupBox.Header>

                                <Grid VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0 0 0 0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="{Binding UnitTextboxWidth}"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="{Binding UnitTextboxWidth}"/>
                                        <ColumnDefinition Width="30"/>
                                        <ColumnDefinition Width="{Binding UnitTextboxWidth}"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="{Binding UnitTextboxWidth}"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <Label 
                                        Grid.Column="0"
                                        Grid.Row="0"
                                        Margin="0 10 0 0"
                                        Content="Interval"
                                        Foreground="{DynamicResource AccentBrush}"
                                        FontSize="{Binding TitleFontSize}">
                                    </Label>

                                    <Grid Grid.Column="0" Grid.Row="1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBox 
                                            Grid.Column="0"
                                            Grid.Row="1"
                                            Style="{StaticResource UnderlineTextBoxStyle}" 
                                            Margin="0 -12 0 0"
                                            Text="{Binding IntervalValue, UpdateSourceTrigger=PropertyChanged}"
                                            FontSize="{Binding TitleFontSize}"
                                            IsEnabled="{Binding MSettingEnable}">
                                            <i:Interaction.Behaviors>
                                                <local:PositiveIntegerBehavior MaxValue="1000"/>
                                            </i:Interaction.Behaviors>
                                        </TextBox>

                                        <TextBlock 
                                            Grid.Column="1"
                                            Grid.Row="1"
                                            Text="(min)" 
                                            Margin="0 0 0 0"
                                            Foreground="{DynamicResource AccentBrush}" 
                                            FontSize="{Binding UnitFontSize}" 
                                            FontWeight="Bold"/>
                                    </Grid>

                                    <Grid Grid.Column="2" Grid.Row="1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBox
                                            Grid.Column="0"
                                            Grid.Row="0"
                                            Style="{StaticResource UnderlineTextBoxStyle}" 
                                            Margin="0 -12 0 0"
                                            Text="{Binding StableOSValue, UpdateSourceTrigger=PropertyChanged}"
                                            FontSize="{Binding TitleFontSize}"
                                            IsEnabled="{Binding MSettingEnable}">
                                            <i:Interaction.Behaviors>
                                                <local:PositiveIntegerBehavior MaxValue="1000"/>
                                            </i:Interaction.Behaviors>
                                        </TextBox>
                                        <TextBlock 
                                            Grid.Column="1"
                                            Grid.Row="1"
                                            Text="(Sec)" 
                                            Margin="0 0 0 0"
                                            Foreground="{DynamicResource AccentBrush}" 
                                            FontSize="{Binding UnitFontSize}" 
                                            FontWeight="Bold"/>
                                    </Grid>

                                    <Label 
                                        Grid.Column="4"
                                        Grid.Row="0"
                                        Content="End Time"
                                        Margin="0 10 0 0"
                                        Foreground="{DynamicResource AccentBrush}"
                                        FontSize="{Binding TitleFontSize}">
                                    </Label>
                                    <Grid Grid.Column="4" Grid.Row="1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBox 
                                            Grid.Column="0"
                                            Grid.Row="3"
                                            Style="{StaticResource UnderlineTextBoxStyle}" 
                                            Margin="0 -12 0 0"
                                            Text="{Binding AttemptsValue, UpdateSourceTrigger=PropertyChanged}"
                                            FontSize="{Binding TitleFontSize}"
                                            IsEnabled="{Binding MSettingEnable}">
                                            <i:Interaction.Behaviors>
                                                <local:PositiveIntegerBehavior MaxValue="100"/>
                                            </i:Interaction.Behaviors>
                                        </TextBox>
                                        <TextBlock 
                                            Grid.Column="1"
                                            Grid.Row="1"
                                            Text="(min)" 
                                            Margin="0 0 0 0"
                                            Foreground="{DynamicResource AccentBrush}" 
                                            FontSize="{Binding UnitFontSize}" 
                                            FontWeight="Bold"/>
                                    </Grid>

                                    <Grid Grid.Column="6" Grid.Row="1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBox
                                            Grid.Column="0"
                                            Grid.Row="0"
                                            Style="{StaticResource UnderlineTextBoxStyle}" 
                                            Margin="0 -12 0 0"
                                            Text="{Binding StableOSValue, UpdateSourceTrigger=PropertyChanged}"
                                            FontSize="{Binding TitleFontSize}"
                                            IsEnabled="{Binding MSettingEnable}">
                                            <i:Interaction.Behaviors>
                                                <local:PositiveIntegerBehavior MaxValue="1000"/>
                                            </i:Interaction.Behaviors>
                                        </TextBox>
                                        <TextBlock 
                                            Grid.Column="1"
                                            Grid.Row="1"
                                            Text="(Sec)" 
                                            Margin="0 0 0 0"
                                            Foreground="{DynamicResource AccentBrush}" 
                                            FontSize="{Binding UnitFontSize}" 
                                            FontWeight="Bold"/>
                                    </Grid>
                                </Grid>
                            </GroupBox>
                        </Grid>
                    </Grid>

                    <!-- 3段目Grid MFM, 計測コマンド -->
                    <Grid Grid.Row="1" HorizontalAlignment="Left" Margin="0 10 0 0" Cursor="">

                        <!-- Outputグループ -->
                        <GroupBox 
                            Style="{StaticResource BalwGroupBoxStyle}"
                            Width="{Binding OutputBoxWidth}"
                            Height="{Binding OutputBoxHeight}">
                            <GroupBox.Header>
                                <Grid VerticalAlignment="Center">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock 
                                        Grid.Column="0"
                                        Text="Output" 
                                        Foreground="{DynamicResource AccentBrush}" 
                                        FontSize="{Binding TitleFontSize}" 
                                        FontWeight="Bold"/>
                                    <Button 
                                        Grid.Column="1"
                                        Style="{StaticResource HoverButtonStyle}"
                                        Background="Transparent"
                                        Foreground="{DynamicResource AccentBrush}"
                                        BorderBrush="{DynamicResource AccentBrush}"
                                        Content="Export CSV"
                                        Width="{Binding OutputBtnSIze}"
                                        Cursor="Hand"
                                        Command="{Binding CalculateGainCommand}"
                                        FontSize="{Binding LabelFontSize}"
                                        Margin="0 0 0 0"
                                        IsEnabled="{Binding CanCalcGain}"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Center" />
                                </Grid>
                            </GroupBox.Header>

                            <Grid Grid.Row="0" HorizontalAlignment="Center" Margin="5 0 5 0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid Margin="0 10 0 0" Cursor="">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Button 
                                        Grid.Row="0"
                                        Grid.Column="2"
                                        Style="{StaticResource HoverButtonStyle}"
                                        Background="Transparent"
                                        Foreground="{DynamicResource AccentBrush}"
                                        BorderBrush="{DynamicResource AccentBrush}"
                                        Content="Mark"
                                        Width="{Binding OutputBtnSIze}"
                                        Cursor="Hand"
                                        Command="{Binding ExportParamsToCsvCommand}"
                                        FontSize="{Binding LabelFontSize}"
                                        Margin="30 0 5 0"
                                        IsEnabled="{Binding CanExport}"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Center" />
                                    <TextBox 
                                        Grid.Column="3"
                                        Grid.Row="0"
                                        Style="{StaticResource UnderlineTextBoxStyle}" 
                                        Text="{Binding IntervalValue, UpdateSourceTrigger=PropertyChanged}"
                                        FontSize="{Binding TitleFontSize}"
                                        Width="120"
                                        Margin="10 0 0 0"
                                        IsEnabled="{Binding MSettingEnable}">
                                        <i:Interaction.Behaviors>
                                            <local:PositiveIntegerBehavior MaxValue="1000"/>
                                        </i:Interaction.Behaviors>
                                    </TextBox>
                                </Grid>

                                <!-- ▼ 測定結果グループ -->
                                <Grid Grid.Row="1" HorizontalAlignment="Center" Margin="0 10 0 0" >
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <GroupBox 
                                        Grid.Row="2" 
                                        Grid.Column="0" 
                                        Margin="0 0 10 0"
                                        Style="{StaticResource GroupBoxSmallMarginStyle}"                      
                                        Width="{Binding MeasureBoxWidth}"                                        
                                        Height="{Binding MeasureBoxHeight}">
                                        <GroupBox.Header>
                                            <StackPanel 
                                            Orientation="Horizontal" 
                                            VerticalAlignment="Center">
                                                <TextBlock 
                                                Text="Measure" 
                                                Foreground="{DynamicResource AccentBrush}" 
                                                FontSize="{Binding TitleFontSize}" 
                                                FontWeight="Bold"/>
                                            </StackPanel>
                                        </GroupBox.Header>

                                        <Grid Margin="2" VerticalAlignment="Center">
                                            <!-- 行定義（11行） -->
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- 列定義 -->
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <Grid Grid.Row="0" Cursor="">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Button 
                                                    Grid.Row="0"
                                                    Grid.Column="0"
                                                    Style="{StaticResource HoverButtonStyle}"
                                                    Background="Transparent"
                                                    Foreground="{DynamicResource AccentBrush}"
                                                    BorderBrush="{DynamicResource AccentBrush}"
                                                    Content="Start"
                                                    Width="{Binding OutputBtnSIze}"
                                                    Cursor="Hand"
                                                    Command="{Binding CalculateGainCommand}"
                                                    FontSize="{Binding LabelFontSize}"
                                                    Margin="0,0,5,0"
                                                    IsEnabled="{Binding CanCalcGain}"
                                                    VerticalAlignment="Center" />
                                                <Button 
                                                    Grid.Row="0"
                                                    Grid.Column="1"
                                                    Style="{StaticResource HoverButtonStyle}"
                                                    Background="Transparent"
                                                    Foreground="{DynamicResource AccentBrush}"
                                                    BorderBrush="{DynamicResource AccentBrush}"
                                                    Content="Stop"
                                                    Width="{Binding OutputBtnSIze}"
                                                    Cursor="Hand"
                                                    Command="{Binding ExportParamsToCsvCommand}"
                                                    FontSize="{Binding LabelFontSize}"
                                                    Margin="15,0,5,0"
                                                    IsEnabled="{Binding CanExport}"
                                                    VerticalAlignment="Center" />
                                            </Grid>
                                            <!-- ===== Column 0 ===== -->
                                            <ItemsControl 
                                                Grid.Row="2"
                                            Grid.Column="0"
                                            ItemsSource="{Binding MesurementItems}"
                                            AlternationCount="11">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Style="{StaticResource MeasureCellBorderStyle}"
                                                        Grid.Row="{Binding RelativeSource={RelativeSource AncestorType=ContentPresenter},
                                                        Path=(ItemsControl.AlternationIndex)}">
                                                            <TextBlock Text="{Binding Value}"
                                                        Style="{StaticResource MeasureTextCenterStyle}"/>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <!-- ===== Column 1 ===== -->
                                            <ItemsControl 
                                                Grid.Row="2"
                                            Grid.Column="1"
                                            ItemsSource="{Binding MesurementValues}"
                                            AlternationCount="11">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border 
                                                        Style="{StaticResource MeasureCellBorderStyle}"
                                                        Grid.Row="{Binding RelativeSource={RelativeSource AncestorType=ContentPresenter},
                                                        Path=(ItemsControl.AlternationIndex)}">
                                                            <TextBlock 
                                                            Text="{Binding Value}"         
                                                            FontSize="{Binding DataContext.LogFontSize,
                                                            RelativeSource={RelativeSource AncestorType=ItemsControl}}">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Opacity" Value="1"/>
                                                                        <Style.Triggers>

                                                                            <!-- 明滅トリガー -->
                                                                            <DataTrigger Binding="{Binding IsUpdate}" Value="True">
                                                                                <DataTrigger.EnterActions>
                                                                                    <BeginStoryboard x:Name="BlinkStoryboard">
                                                                                        <Storyboard>
                                                                                            <DoubleAnimation
                                                                                        Storyboard.TargetProperty="Opacity"
                                                                                        From="1"
                                                                                        To="0.3"
                                                                                        Duration="0:0:0.25"
                                                                                        AutoReverse="True"
                                                                                        RepeatBehavior="Forever"/>
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.EnterActions>

                                                                                <!-- 終了時に確実に元に戻す -->
                                                                                <DataTrigger.ExitActions>
                                                                                    <BeginStoryboard>
                                                                                        <Storyboard>
                                                                                            <DoubleAnimation
                                                                                        Storyboard.TargetProperty="Opacity"
                                                                                        To="1"
                                                                                        Duration="0"/>
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.ExitActions>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Grid>
                                    </GroupBox>

                                    <!-- ロググループ -->
                                    <GroupBox 
                                    Grid.Row="2"
                                    Grid.Column="1"
                                    Style="{StaticResource LogGroupBoxStyle}"
                                    Width="{Binding LogBoxWidth}"
                                    Height="{Binding LogBoxHeight}">

                                        <GroupBox.Header>
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock 
                                                Text="Log"
                                                Foreground="{DynamicResource AccentBrush}"
                                                FontSize="{Binding TitleFontSize}"
                                                FontWeight="Bold"/>
                                            </StackPanel>
                                        </GroupBox.Header>

                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <!-- Auto → * に変更（最重要） -->
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>

                                            <ListBox x:Name="LogListBox"
                                             ItemsSource="{Binding Logs}"
                                             Foreground="{DynamicResource AccentBrush}"
                                             Background="Transparent"
                                             BorderThickness="0"
                                             FontFamily="Consolas"
                                             FontSize="{Binding LogFontSize}"
                                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">

                                                <ListBox.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <VirtualizingStackPanel />
                                                    </ItemsPanelTemplate>
                                                </ListBox.ItemsPanel>
                                            </ListBox>
                                        </Grid>
                                    </GroupBox>
                                </Grid>

                                <Button 
                                        Grid.Row="2"
                                        Grid.Column="0"
                                        Style="{StaticResource HoverButtonStyle}"
                                        Background="Transparent"
                                        Foreground="{DynamicResource AccentBrush}"
                                        BorderBrush="{DynamicResource AccentBrush}"
                                        Content="Clear"
                                        Width="{Binding OutputBtnSIze}"
                                        Cursor="Hand"
                                        Command="{Binding CalculateGainCommand}"
                                        FontSize="{Binding LabelFontSize}"
                                        Margin="0 10 0 0"
                                        IsEnabled="{Binding CanCalcGain}"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Center" />
                            </Grid>
                        </GroupBox>
                    </Grid>
                </Grid>
            </Grid>
        </ScrollViewer>

        <!-- 右下隅矩形（ScrollBar 表示に連動） -->
        <Border 
            x:Name="ScrollCorner"
            Width="{x:Static SystemParameters.VerticalScrollBarWidth}"
            Height="{x:Static SystemParameters.HorizontalScrollBarHeight}"
            Background="{DynamicResource LeftWindowColor2Brush}"
            BorderBrush="{DynamicResource AccentBrush}"
            BorderThickness="1"
            HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Visibility="Collapsed"/>

    </Grid>
</UserControl>